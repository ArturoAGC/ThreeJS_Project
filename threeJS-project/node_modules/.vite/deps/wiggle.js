import {
  Mesh,
  MeshBasicMaterial,
  Quaternion,
  SphereGeometry,
  Vector3
} from "./chunk-73BEQU36.js";

// node_modules/wiggle/dist/index.mjs
var c = {
  velocity: 0.1,
  maxStretch: 0.1
};
var o = new Vector3();
var d = new Vector3();
var s = new Mesh(
  new SphereGeometry(0.03),
  new MeshBasicMaterial({ transparent: true })
);
var f = class {
  constructor(t, e = {}, i = false) {
    this.options = { ...c, ...e };
    const n = t.clone();
    t.parent.add(n), n.add(t), this.target = t, this.targetHelper = s.clone(), e.scene && e.scene.add(this.targetHelper), this.currentHelper = s.clone(), e.scene && e.scene.add(this.currentHelper), this.currentHelper.add(s.clone()), this.currentHelper.children[0].position.y = -0.1, this._isFirstStep = true, this.originPosition = t.position.clone(), this.originRotation = t.rotation.clone(), this.oldBoneWorldPosition = new Vector3(), this.oldBoneWorldRotation = new Quaternion(), this.target.getWorldPosition(this.oldBoneWorldPosition), this.target.getWorldQuaternion(this.oldBoneWorldRotation), this.restLength = this.target.parent.position.length();
  }
  reset() {
    this._isFirstStep = true, this.target.position.copy(this.originPosition), this.target.rotation.copy(this.originRotation), this.target.updateMatrixWorld(true, false), this.target.getWorldPosition(this.oldBoneWorldPosition);
  }
  dispose() {
    this.reset();
    const t = this.target.parent, e = t.parent;
    e.remove(t), e.add(this.target);
  }
  update(t = null) {
    if (!t)
      if (this.ms) {
        const i = performance.now();
        t = i - this.ms, t /= 1e3, this.ms = i;
      } else
        this.ms = performance.now(), t = 16 / 1e3;
    let e = 1;
    if (t = Math.min(t, 100), t > 0.01 && (e = 2), t >= 100 && (e = 25), !(t < 6e-3))
      for (let i = 0; i < e; i++)
        this.step(85e-4 * 100);
  }
  step(t) {
    this.target.parent.updateMatrixWorld(true, false), this.targetHelper.position.copy(this.originPosition), this.target.parent.localToWorld(this.targetHelper.position), this._isFirstStep && (this._isFirstStep = false, this.oldBoneWorldPosition.copy(this.targetHelper.position)), o.copy(this.oldBoneWorldPosition).lerp(
      this.targetHelper.position,
      Math.min(this.options.velocity * t, 0.99999)
    ), this.target.position.copy(o), this.target.parent.worldToLocal(this.target.position), this.oldBoneWorldPosition.copy(o);
    const e = this.target.parent.getWorldPosition(d);
    this.currentHelper.position.copy(o), this.currentHelper.updateMatrixWorld(true, false), this.currentHelper.lookAt(e);
    const i = this.target.position.clone();
    i.normalize(), this.target.up.set(0, 1, 0), this.target.quaternion.setFromUnitVectors(this.target.up, i), this.target.position.set(0, 0, 0), this.target.updateMatrix();
  }
};
export {
  f as WiggleBone
};
//# sourceMappingURL=wiggle.js.map
